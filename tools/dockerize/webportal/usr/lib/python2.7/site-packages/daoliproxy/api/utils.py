#-*- coding:utf-8 -*-
import random
import string

import sys
reload(sys)
sys.setdefaultencoding('utf8')

from webob import exc

from oslo.config import cfg
from daoliproxy.utils import send_mail

CONF = cfg.CONF
CONF.register_opt(cfg.StrOpt('public_key', secret=True, default='public'))
CONF.register_opt(cfg.ListOpt('email_cc', default=[], help='Send email to administrator'))

ALLOW_HOSTS = ['127.0.0.1', 'localhost']

def create_password():
    words = string.ascii_letters + string.digits
    return ''.join(random.sample(words, 8))

def local_req(m):
    def _wrap(*args, **kwargs):
        req = kwargs['req']
        if req.client_addr not in ALLOW_HOSTS or \
                req.host.split(':')[0] not in ALLOW_HOSTS:
            key = req.headers.get('X-Key')
            if not key or key != CONF.public_key:
                msg = "Invalid request"
                return exc.HTTPBadRequest(explanation=msg)
        return m(*args, **kwargs)
    return _wrap

def register_sendmail(auth):
    email_body = "<br/>" +\
                     "Send to: " + auth['email'] + "<br/>" +\
                     "Username: " + auth['username'] +"<br/>" +\
                     "Password: " + auth['password'] +"<br/><br/>" +\
                     "Company: " + auth['company'] + "<br/>" +\
                     "Phone: " + auth['phone'] + "<br/>" +\
                     "Reason: " + auth['reason'] + "<br/><br/>"
    en_emailbody = "Dear User, <br/><br/>" +\
                   "Thank you for registering a trial account! Your account information is as follows:<br/><br/>" +\
                   "Username: " + auth['username'] + "<br/>Password: " + auth['password'] + "<br/>URL: " + \
                   "http://www.daolicloud.com/<br/><br/>" +\
                   "Your instances' initial SSH username & password: <br/>" +\
                   "Username: root<br/>" +\
                   "Password: daoli123<br/><br/>" +\
                   "Please change your instances initial password immediately upon login.<br/>" +\
                   "If you encounter any problem please let us know by sending email to:<br/>" +\
                   "nvi@daolicloud.com<br/><br/>" +\
                   "Thank you very much!<br/>" +\
                   "DaoliCloud<br/><br/>"
    receivers = [{'email': auth['email'],
                  'subject': 'Welcome to Register Daolicloud',
                  'body': en_emailbody}]
    subject = 'New User: %s [%s]' % (auth['username'], auth['email'])
    for contact in CONF.get('email_cc', []):
        receivers.append({'email': contact, 'subject': subject,
                          'body': email_body + en_emailbody})
    send_mail(receivers)
