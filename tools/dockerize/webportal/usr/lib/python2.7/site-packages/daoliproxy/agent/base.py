from daoliproxy import exception

def get_service_from_catalog(catalog, service_type):
    if catalog:
        for service in catalog:
            if service['type'] == service_type:
                return service
    return None

def get_url_for_service(service, endpoint_type):
    for endpoint in service['endpoints']:
        if endpoint['interface'] == endpoint_type:
            return endpoint['url']
    return None

def url_for(catalog, service_type, endpoint_type='public'):
    service = get_service_from_catalog(catalog, service_type)
    if service:
        url = get_url_for_service(service, endpoint_type)
        if url:
            return url
    raise exception.ServiceCatalogException(service_type)

class APIResourceWrapper(object):
    """Simple wrapper for api objects.

    Define _attrs on the child class and pass in the
    api object as the only argument to the constructor
    """
    _attrs = []
    _apiresource = None  # Make sure _apiresource is there even in __init__.

    def __init__(self, apiresource):
        self._apiresource = apiresource

    def __getattribute__(self, attr):
        try:
            return object.__getattribute__(self, attr)
        except AttributeError:
            if attr not in self._attrs:
                raise
            # __getattr__ won't find properties
            return getattr(self._apiresource, attr)

    def __repr__(self):
        return "<%s: %s>" % (self.__class__.__name__,
                             dict((attr, getattr(self, attr))
                                  for attr in self._attrs
                                  if hasattr(self, attr)))
