from oslo.config import cfg
from migrate.changeset import UniqueConstraint
from sqlalchemy import Boolean, Column, DateTime, Float
from sqlalchemy import dialects
from sqlalchemy import ForeignKey, Index, Integer, MetaData, String, Table
from sqlalchemy import Text

from daoliproxy.i18n import _
from daoliproxy.openstack.common import uuidutils
from daoliproxy.openstack.common import timeutils
from daoliproxy.openstack.common import log as logging

CONF = cfg.CONF
CONF.register_opt(cfg.StrOpt('default_password', default='daoli123'))

LOG = logging.getLogger(__name__)

def MediumText():
    return Text().with_variant(dialects.mysql.MEDIUMTEXT(), 'mysql')

def upgrade(migrate_engine):
    meta = MetaData()
    meta.bind = migrate_engine

    users = Table('user', meta,
        Column('created_at', DateTime),
        Column('updated_at', DateTime),
        Column('uuid', String(length=36), primary_key=True, nullable=False),
        Column('username', String(length=255), nullable=False),
        Column('password', String(length=255), nullable=False),
        Column('email', String(length=255), nullable=False),
        Column('type', Integer, default=0),
        Column('phone', String(length=11), nullable=False),
        Column('company', String(length=255), nullable=False),
        Column('reason', String(length=255), nullable=False),
        Column('enabled', Boolean, default=True),
        Column('extra', MediumText(), default='{}'),
        mysql_engine='InnoDB',
        mysql_charset='utf8'
    )

    user_tasks = Table('user_tasks', meta,
        Column('id', Integer, primary_key=True, nullable=False),
        Column('utype', String(length=10), nullable=False),
        Column('uobj', MediumText()),
        mysql_engine='InnoDB',
        mysql_charset='utf8'
    )

    user_logins = Table('user_login', meta,
        Column('created_at', DateTime),
        Column('updated_at', DateTime),
        Column('id', Integer, primary_key=True, nullable=False),
        Column('user_id', String(length=36), nullable=False),
        Column('user_addr', String(length=17)),
        Column('user_type', String(length=255)),
        mysql_engine='InnoDB',
        mysql_charset='utf8'
    )

    instances = Table('instances', meta,
        Column('created_at', DateTime),
        Column('updated_at', DateTime),
        Column('id', String(length=36), primary_key=True, nullable=False),
        Column('name', String(length=255), nullable=False),
        Column('address', String(length=15)),
        Column('mac_address', String(length=17)),
        Column('phy_ipv4', String(length=15)),
        Column('host', String(length=100)),
        Column('project_id', String(length=36), nullable=False),
        Column('user_id', String(36), nullable=False),
        Column('availability_zone', String(length=36), nullable=False),
        Column('image', String(length=36), nullable=False),
        Column('flavor', String(length=36), nullable=False),
        Column('status', String(length=10), default=None),
        Column('power_state', Integer),
        Column('fake_hostname', String(length=255)),
        mysql_engine='InnoDB',
        mysql_charset='utf8'
    )

    user_projects = Table('user_project', meta,
        Column('id', Integer, primary_key=True, nullable=False),
        Column('user_id', String(length=36), nullable=False),
        Column('project_id', String(length=36), nullable=False),
        Column('keystone_user_id', String(length=36), nullable=False),
        Column('zone_id', String(length=36), nullable=False),
        Column('total_instances', Integer, nullable=False, default=10),
        mysql_engine='InnoDB',
        mysql_charset='utf8'
    )

    firewalls = Table('firewalls', meta,
        Column('id', String(length=255), primary_key=True),
        Column('hostname', String(length=255), nullable=False),
        Column('gateway_port', Integer, nullable=False),
        Column('service_port', Integer, nullable=False),
        Column('instance_id', String(length=36), nullable=False),
        Column('fake_zone', Boolean, nullable=False),
        UniqueConstraint('hostname', 'gateway_port',
                         name="uniq_hostname0gateway_port"),
        mysql_engine='InnoDB',
        mysql_charset='utf8'
    )

    single_security_groups = Table('single_security_groups', meta,
        Column('id', Integer, primary_key=True, nullable=False),
        Column('top', String(length=36), nullable=False),
        Column('bottom', String(length=36), nullable=False),
        Column('user_id', String(length=36), nullable=False),
        UniqueConstraint('top', 'bottom', 'user_id',
                         name="uniq_single_security_group0top0bottom0user_id"),
        mysql_engine='InnoDB',
        mysql_charset='utf8'
    )

    project_networks = Table('project_networks', meta,
        Column('id', Integer, primary_key=True, nullable=False),
        Column('third', Integer, nullable=False, default=0),
        Column('fourth', Integer, nullable=False, default=2),
        Column('project_id', String(length=36), nullable=False),
        mysql_engine='InnoDB',
        mysql_charset='utf8'
    )

    gateways = Table('gateways', meta,
        Column('id', Integer, primary_key=True, nullable=False),
        Column('hostname', String(length=255), nullable=False),
        Column('int_ip', String(length=15), nullable=False),
        Column('ext_ip', String(length=15), nullable=False),
        Column('mac_address', String(length=17), nullable=False),
        Column('gw_mac', String(length=17), nullable=False),
        Column('zone', String(length=36), nullable=False),
        Column('count', Integer, nullable=False, default=0),
        Column('idc_id', Integer, nullable=False),
        mysql_engine='InnoDB',
        mysql_charset='utf8'
    )

    images = Table('images', meta,
        Column('id', String(length=36), primary_key=True, nullable=False),
        Column('name', String(length=255), nullable=False),
        Column('checksum', String(length=32)),
        Column('container_format', String(length=32), nullable=False),
        Column('disk_format', String(length=32), default='raw'),
        Column('is_public', Boolean, default=True),
        Column('min_disk', Integer, default=0),
        Column('min_ram', Integer, default=0),
        Column('size', Integer, nullable=False),
        Column('owner', String(length=32)),
        Column('status', String(length=32)),
        Column('property', MediumText()),
        Column('display_format', String(length=32)),
        Column('zone', String(length=36), nullable=False),
        mysql_engine='InnoDB',
        mysql_charset='utf8'
    )

    zones = Table('zones', meta,
        Column('id', String(length=36), primary_key=True, nullable=False),
        Column('name', String(length=255), nullable=False),
        Column('auth_url', String(length=255), nullable=False),
        Column('token', String(length=255), nullable=False),
        Column('default_instances', Integer, nullable=False, default=10),
        Column('disabled', Boolean, default=False),
        mysql_engine='InnoDB',
        mysql_charset='utf8'
    )

    flavors = Table('flavors', meta,
        Column('id', Integer, primary_key=True, nullable=False),
        Column('flavorid', String(length=36), nullable=False),
        Column('name', String(length=255)),
        Column('vcpus', Integer, nullable=False),
        Column('ram', Integer, nullable=False),
        Column('disk', Integer, nullable=False),
        Column('swap', String(length=10), default=''),
        Column('ephemeral', Integer),
        Column('rxtx_factor', Float, default=1),
        Column('is_public', Boolean, default=True),
        Column('zone', String(36), nullable=False),
        mysql_engine='InnoDB',
        mysql_charset='utf8'
    )

    resources = Table('resources', meta,
        Column('created_at', DateTime),
        Column('updated_at', DateTime),
        Column('id', Integer, primary_key=True, nullable=False),
        Column('source_name', String(length=255), nullable=False),
        Column('source_id', String(length=255), nullable=False),
        Column('action', String(length=255), nullable=False),
        Column('extra', MediumText()),
        Column('project_id', String(36), nullable=False),
        Column('user_id', String(36), nullable=False),
        mysql_engine='InnoDB',
        mysql_charset='utf8'
    )

    ipavailabilityranges = Table('ipavailabilityranges', meta,
        Column('allocation_pool_id', String(length=36),
            ForeignKey('ipallocationpools.id', ondelete="CASCADE"),
            primary_key=True),
        Column('first_ip', String(length=64), nullable=False),
        Column('last_ip', String(length=64), nullable=False),
        mysql_engine='InnoDB',
        mysql_charset='utf8'
    )

    ipallocationpools = Table('ipallocationpools', meta,
        Column('id', String(length=36), primary_key=True, nullable=False),
        Column('subnet_id', String(length=36), 
            ForeignKey('subnets.id', ondelete="CASCADE")),
        Column('first_ip', String(length=64), nullable=False),
        Column('last_ip', String(length=64), nullable=False),
        mysql_engine='InnoDB',
        mysql_charset='utf8'
    )

    subnets = Table('subnets', meta,
        Column('id', String(length=36), primary_key=True, nullable=False),
        Column('name', String(length=255)),
        Column('cidr', String(length=64), nullable=False),
        Column('gateway_ip', String(length=64)),
        Column('net_type', Integer, nullable=False),
        Column('user_id', String(length=36), nullable=False),
        mysql_engine='InnoDB',
        mysql_charset='utf8'
    )

    services = Table('services', meta,
        Column('id', Integer, primary_key=True, nullable=False),
        Column('hostname', String(length=255), nullable=False),
        Column('int_ip', String(length=15), nullable=False),
        Column('ext_ip', String(length=15), nullable=False),
        Column('topic', String(length=20), nullable=False),
        Column('zone_id', String(length=36), nullable=False),
        Column('idc_id', Integer, nullable=False),
        mysql_engine='InnoDB',
        mysql_charset='utf8'
    )

    # create all tables
    tables = [users, user_tasks, user_logins, user_projects,
             instances, single_security_groups, firewalls,
             gateways, images, zones, flavors, resources, services,
             project_networks, subnets, ipallocationpools, ipavailabilityranges]

    for table in tables:
        try:
            table.create()
        except Exception:
            LOG.info(repr(table))
            LOG.exception(_('Exception while creating table.'))
            raise

    current_time = timeutils.utcnow()

    users.insert().execute(
            {'uuid': uuidutils.generate_uuid(),
             'username': 'admin', 'password': CONF.default_password,
             'email': 'nvi@daolicloud.com', 'phone': '01082823993',
             'company': 'Daolicloud.com', 'reason': 'Administrator',
             'created_at': current_time, 'updated_at': current_time,
            })

def downgrade(migrate_engine):
    raise NotImplementedError('Downgrade is unsupported.')
