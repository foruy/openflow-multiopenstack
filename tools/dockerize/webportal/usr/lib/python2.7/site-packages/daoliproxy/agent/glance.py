import itertools
import six.moves.urllib.parse as urlparse

import glanceclient as glance_client

from daoliproxy.utils import url_for
from daoliproxy.openstack.common import log as logging

LOG = logging.getLogger(__name__)

def glanceclient(request):
    o = urlparse.urlparse(url_for(request, 'image'))
    url = "://".join((o.scheme, o.netloc))
    LOG.debug('glanceclient connection created using token "%s" and url "%s"'
              % (request.id, url))
    return glance_client.Client('1', url, token=request.id,
                                insecure=False, cacert=None)

def image_list_detailed(request, marker=None, filters=None, paginate=False):
    limit = 1000
    page_size = 20

    if paginate:
        request_size = page_size + 1
    else:
        request_size = limit

    kwargs = {'filters': filters or {}}
    if marker:
        kwargs['marker'] = marker

    images_iter = glanceclient(request).images.list(page_size=request_size,
                                                    limit=limit,
                                                    **kwargs)

    has_more_data = False
    if paginate:
        images = list(itertools.islice(images_iter, request_size))
        if len(images) > page_size:
            images.pop(-1)
            has_more_data = True
    else:
        images = list(images_iter)

    return (images, has_more_data)
